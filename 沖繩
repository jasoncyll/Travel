import React, { useState, useEffect, useRef } from 'react';
import { 
  Bike, 
  MapPin, 
  Calendar, 
  Coffee, 
  Utensils, 
  Hotel, 
  Waves, 
  CheckCircle2, 
  Circle, 
  Plus, 
  Navigation,
  Sun,
  Mountain,
  Wind,
  Map as MapIcon,
  Upload,
  Activity,
  ArrowUpRight,
  TrendingUp,
  Car,
  Footprints,
  Bus,
  Save,
  X,
  Clock,
  Cloud,
  CloudRain,
  CloudLightning,
  CalendarDays,
  Loader2,
  AlertCircle,
  ExternalLink,
  Trash2,
  Search,
  AlertTriangle
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  onSnapshot 
} from 'firebase/firestore';

// --- Firebase 初始化 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- GPX 解析工具 ---
const parseGPX = (gpxContent) => {
  if (!gpxContent) return null;
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(gpxContent, "text/xml");
  const trkpts = xmlDoc.getElementsByTagName("trkpt");
  
  if (trkpts.length === 0) return null;

  const points = [];
  let totalDistance = 0;
  let totalElevationGain = 0;
  
  const toRad = (x) => x * Math.PI / 180;
  const getDist = (p1, p2) => {
    const R = 6371000;
    const dLat = toRad(p2.lat - p1.lat);
    const dLon = toRad(p2.lon - p1.lon);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(toRad(p1.lat)) * Math.cos(toRad(p2.lat)) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  };

  for (let i = 0; i < trkpts.length; i++) {
    const lat = parseFloat(trkpts[i].getAttribute("lat"));
    const lon = parseFloat(trkpts[i].getAttribute("lon"));
    const ele = parseFloat(trkpts[i].getElementsByTagName("ele")[0]?.textContent || 0);
    
    // 簡單抽樣以優化效能
    if (i % 5 === 0 || i === trkpts.length - 1) {
      if (points.length > 0) {
        const lastPoint = points[points.length - 1];
        const dist = getDist(lastPoint, { lat, lon });
        totalDistance += dist;
        const diff = ele - lastPoint.ele;
        if (diff > 0.5) totalElevationGain += diff;
      }
      points.push({ lat, lon, ele, dist: totalDistance });
    }
  }

  return { points, totalDistance, totalElevationGain };
};

const RouteVisualizer = ({ gpxData, onUpload, isUploading }) => {
  const fileInputRef = useRef(null);
  const mapContainerRef = useRef(null);
  const mapInstanceRef = useRef(null);

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => onUpload(e.target.result);
      reader.readAsText(file);
    }
  };

  useEffect(() => {
    if (!gpxData || !mapContainerRef.current) return;

    let isMounted = true;
    let mapInstance = mapInstanceRef.current;

    const initializeMap = () => {
        if (!isMounted || !mapContainerRef.current || !window.L || !window.L.map) return;
        
        if (mapInstance) {
            mapInstance.off();
            mapInstance.remove();
        }

        try {
            const map = window.L.map(mapContainerRef.current);
            mapInstanceRef.current = map;
            mapInstance = map;

            window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            if (gpxData.points.length > 0) {
                 const latlngs = gpxData.points.map(p => [p.lat, p.lon]);
                 const polyline = window.L.polyline(latlngs, { color: '#3b82f6', weight: 5, opacity: 0.8 }).addTo(map);
                 
                 map.fitBounds(polyline.getBounds(), { padding: [20, 20] });

                 const startIcon = window.L.divIcon({
                   className: 'custom-div-icon',
                   html: "<div style='background-color: #10b981; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);'></div>",
                   iconSize: [12, 12],
                   iconAnchor: [6, 6]
                 });
                 window.L.marker(latlngs[0], { icon: startIcon }).addTo(map).bindPopup("<b>起點</b>");

                 const endIcon = window.L.divIcon({
                   className: 'custom-div-icon',
                   html: "<div style='background-color: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);'></div>",
                   iconSize: [12, 12],
                   iconAnchor: [6, 6]
                 });
                 window.L.marker(latlngs[latlngs.length - 1], { icon: endIcon }).addTo(map).bindPopup("<b>終點</b>");
            }
        } catch (err) {
            console.error("Map initialization failed:", err);
        }
    };

    if (window.L && window.L.map) {
        initializeMap();
    } else {
        let script = document.getElementById('leaflet-script');
        
        if (!script) {
            script = document.createElement('script');
            script.id = 'leaflet-script';
            script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            script.async = true;
            document.body.appendChild(script);
            
            if (!document.getElementById('leaflet-css')) {
                const link = document.createElement('link');
                link.id = 'leaflet-css';
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(link);
            }
        }
        
        const onScriptLoad = () => {
            if (isMounted) initializeMap();
        };
        script.addEventListener('load', onScriptLoad);
        
        return () => {
            isMounted = false;
            script.removeEventListener('load', onScriptLoad);
            if (mapInstance) {
                mapInstance.remove();
                mapInstanceRef.current = null;
            }
        };
    }

    return () => {
        isMounted = false;
        if (mapInstance) {
            mapInstance.remove();
            mapInstanceRef.current = null;
        }
    };
  }, [gpxData]);

  if (!gpxData) {
    return (
      <div 
        onClick={() => !isUploading && fileInputRef.current.click()}
        className={`border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:bg-slate-50 hover:border-blue-400 hover:text-blue-500 transition-all bg-white ${isUploading ? 'opacity-50 cursor-wait' : ''}`}
      >
        {isUploading ? (
          <Loader2 className="w-10 h-10 mb-2 animate-spin text-blue-500" />
        ) : (
          <Upload className="w-10 h-10 mb-2" />
        )}
        <p className="font-semibold">{isUploading ? "上傳同步中..." : "上傳 GPX 路線檔"}</p>
        <p className="text-xs mt-1">{isUploading ? "請稍候" : "上傳後將自動分享給所有使用者"}</p>
        <input 
          type="file" 
          accept=".gpx" 
          ref={fileInputRef} 
          className="hidden" 
          onChange={handleFileChange}
          disabled={isUploading}
        />
      </div>
    );
  }

  const { points, totalDistance, totalElevationGain } = gpxData;
  const maxEle = Math.max(...points.map(p => p.ele));
  const minEle = Math.min(...points.map(p => p.ele));
  const eleRange = maxEle - minEle || 100;
  const graphW = 300;
  const graphH = 100;

  const areaPath = points.map((p, i) => {
    const x = (p.dist / totalDistance) * graphW;
    const y = graphH - ((p.ele - minEle) / eleRange) * graphH;
    return `${i === 0 ? 'M' : 'L'} ${x},${y}`;
  }).join(' ');
  const areaFill = `${areaPath} L ${graphW},${graphH} L 0,${graphH} Z`;

  return (
    <div className="space-y-4 animate-in fade-in zoom-in duration-300">
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-blue-50 p-3 rounded-lg flex items-center gap-3">
           <div className="bg-blue-200 p-2 rounded-full text-blue-700"><TrendingUp size={18} /></div>
           <div>
             <div className="text-xs text-blue-400 uppercase font-bold">實測距離</div>
             <div className="text-lg font-bold text-blue-900">{(totalDistance / 1000).toFixed(1)} km</div>
           </div>
        </div>
        <div className="bg-orange-50 p-3 rounded-lg flex items-center gap-3">
           <div className="bg-orange-200 p-2 rounded-full text-orange-700"><Mountain size={18} /></div>
           <div>
             <div className="text-xs text-orange-400 uppercase font-bold">總爬升</div>
             <div className="text-lg font-bold text-orange-900">{Math.round(totalElevationGain)} m</div>
           </div>
        </div>
      </div>

      <div className="bg-slate-100 rounded-xl overflow-hidden shadow-inner border border-slate-200 relative">
        <h4 className="absolute top-2 left-2 z-[400] bg-white/90 px-2 py-1 rounded text-xs font-bold text-slate-600 shadow-sm flex items-center gap-1">
          <MapPin size={12} /> 路線與周邊 (OpenStreetMap)
        </h4>
        <div 
          ref={mapContainerRef} 
          style={{ height: '300px', width: '100%' }} 
          className="z-0"
        />
      </div>

      <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
        <div className="flex justify-between items-end mb-2">
           <h4 className="text-slate-500 text-xs font-bold flex items-center gap-1">
             <Activity size={12} /> 海拔剖面 (Elevation)
           </h4>
           <span className="text-[10px] text-slate-400">最高點: {Math.round(maxEle)}m</span>
        </div>
        <svg width="100%" height={graphH} viewBox={`0 0 ${graphW} ${graphH}`} preserveAspectRatio="none">
          <defs>
            <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style={{stopColor:'rgb(249, 115, 22)', stopOpacity:0.6}} />
              <stop offset="100%" style={{stopColor:'rgb(249, 115, 22)', stopOpacity:0.1}} />
            </linearGradient>
          </defs>
          <path d={areaFill} fill="url(#grad1)" />
          <path d={areaPath} fill="none" stroke="#f97316" strokeWidth="2" />
        </svg>
        <div className="flex justify-between text-[10px] text-slate-400 mt-1 font-mono">
          <span>START</span>
          <span>{(totalDistance/2000).toFixed(1)}km</span>
          <span>FINISH</span>
        </div>
      </div>
      
      <button 
        onClick={() => fileInputRef.current.click()}
        disabled={isUploading}
        className="w-full py-2 text-xs text-slate-400 hover:text-blue-500 border border-transparent hover:border-blue-200 rounded-lg transition-colors flex items-center justify-center gap-1"
      >
        {isUploading ? <Loader2 size={12} className="animate-spin" /> : <Upload size={12} />}
        {isUploading ? "同步中..." : "重新上傳 GPX"}
      </button>
      <input type="file" accept=".gpx" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
    </div>
  );
};

// 預設行程資料
const defaultItinerary = [
  {
    day: 1,
    title: "抵達與安頓",
    date: "Day 1",
    summary: "抵達那霸機場，租車/接駁前往中部住宿，晚間探索美國村。",
    location: "美國村 (American Village)",
    coordinates: { lat: 26.3167, lon: 127.7579 }, 
    activities: [
      { 
        id: 'd1-1', 
        time: "14:00", 
        title: "抵達那霸機場 (OKA)", 
        type: "transport", 
        icon: <Navigation className="w-5 h-5" />, 
        desc: "領取行李，前往租車行或搭乘接駁巴士。",
        // Day 1 第一站：那霸機場
        coordinates: { lat: 26.2048, lon: 127.6458 }
      },
      { 
        id: 'd1-2', 
        time: "16:00", 
        title: "飯店 Check-in", 
        type: "hotel", 
        icon: <Hotel className="w-5 h-5" />, 
        desc: "建議住宿：恩納村 (Onna) 或 讀谷村 (Yomitan) 海濱飯店。",
        travel: { mode: "car", duration: "60 mins" },
        coordinates: { lat: 26.4353, lon: 127.7925 }
      },
      { 
        id: 'd1-3', 
        time: "18:00", 
        title: "美國村落日與晚餐", 
        type: "sightseeing", 
        icon: <Sun className="w-5 h-5" />, 
        desc: "在 Depot Island 散步，欣賞日落，選擇一家海景餐廳用餐。",
        travel: { mode: "car", duration: "20 mins" },
        coordinates: { lat: 26.3167, lon: 127.7579 }
      },
    ]
  },
  {
    day: 2,
    title: "蔚藍海路 (輕鬆騎行)",
    date: "Day 2",
    summary: "早晨享受平坦的海中道路騎行，下午放鬆或探訪濱比嘉島。",
    location: "宇流麻市 (Uruma) - 海中道路",
    isCyclingDay: true,
    coordinates: { lat: 26.3339, lon: 127.9332 },
    rideStats: {
      difficulty: "輕鬆 ⭐",
      distance: "25 km",
      elevation: "50 m",
      route: "海中道路 -> 濱比嘉島 -> 平安座島 -> 返回"
    },
    activities: [
      { 
        id: 'd2-1', 
        time: "07:30", 
        title: "出發前往海中道路", 
        type: "transport", 
        icon: <Navigation className="w-5 h-5" />, 
        desc: "開車載著單車前往海中道路停車場。",
        // Day 2 第一站：海中道路
        coordinates: { lat: 26.3308, lon: 127.9247 }
      },
      { 
        id: 'd2-2', 
        time: "08:30", 
        title: "單車騎行：海中道路", 
        type: "cycling", 
        icon: <Bike className="w-5 h-5" />, 
        desc: "在那片把海分開的道路上騎行。路況平坦，風景極佳，非常適合拍照。",
        travel: { mode: "car", duration: "30 mins" },
        coordinates: { lat: 26.3339, lon: 127.9332 }
      },
      { 
        id: 'd2-3', 
        time: "11:00", 
        title: "濱比嘉島午餐", 
        type: "food", 
        icon: <Utensils className="w-5 h-5" />, 
        desc: "享用當地的塔可飯 (Taco Rice) 或海鮮食堂。",
        travel: { mode: "bike", duration: "0 mins" },
        coordinates: { lat: 26.3197, lon: 127.9622 }
      },
      { 
        id: 'd2-4', 
        time: "14:00", 
        title: "返回飯店 / 自由活動", 
        type: "leisure", 
        icon: <Coffee className="w-5 h-5" />, 
        desc: "飯店海灘休息，或前往萬座毛看風景。",
        travel: { mode: "car", duration: "40 mins" }
      },
    ]
  },
  {
    day: 3,
    title: "北部挑戰與黑潮 (挑戰騎行)",
    date: "Day 3",
    summary: "挑戰本部半島的山海路線，午後參觀美麗海水族館。",
    location: "本部町 (Motobu) / 美麗海水族館",
    isCyclingDay: true,
    coordinates: { lat: 26.6944, lon: 127.8779 },
    rideStats: {
      difficulty: "中/難 ⭐⭐⭐",
      distance: "40-60 km",
      elevation: "350 m",
      route: "名護市 -> 本部半島環線 -> 古宇利大橋(選修)"
    },
    activities: [
      { 
        id: 'd3-1', 
        time: "07:00", 
        title: "移動至北部名護", 
        type: "transport", 
        icon: <Navigation className="w-5 h-5" />, 
        desc: "開車前往北部起點（如名護市民會館停車場）。",
        // Day 3 第一站：名護市民會館周邊
        coordinates: { lat: 26.5915, lon: 127.9773 }
      },
      { 
        id: 'd3-2', 
        time: "08:00", 
        title: "單車騎行：本部半島環線", 
        type: "cycling", 
        icon: <Mountain className="w-5 h-5" />, 
        desc: "有起伏的丘陵地形，沿途經過備瀨福木林道，挑戰體力。",
        travel: { mode: "car", duration: "50 mins" },
        coordinates: { lat: 26.6944, lon: 127.8779 }
      },
      { 
        id: 'd3-3', 
        time: "13:00", 
        title: "美麗海水族館", 
        type: "sightseeing", 
        icon: <Waves className="w-5 h-5" />, 
        desc: "必去景點。參觀黑潮之海大水槽，看鯨鯊餵食秀（通常 15:00）。",
        travel: { mode: "car", duration: "20 mins" },
        coordinates: { lat: 26.6944, lon: 127.8779 }
      },
      { 
        id: 'd3-4', 
        time: "18:00", 
        title: "燒肉晚餐", 
        type: "food", 
        icon: <Utensils className="w-5 h-5" />, 
        desc: "回到名護市區或住宿附近，享用阿古豬或石垣牛燒肉補充體力。",
        travel: { mode: "car", duration: "15 mins" }
      },
    ]
  },
  {
    day: 4,
    title: "最後採買與返程",
    date: "Day 4",
    summary: "悠閒早餐，前往 Outlet 或國際通採買伴手禮，前往機場。",
    location: "那霸市 / 機場",
    coordinates: { lat: 26.2048, lon: 127.6458 },
    activities: [
      { 
        id: 'd4-1', 
        time: "09:00", 
        title: "悠閒早餐 & Check-out", 
        type: "hotel", 
        icon: <Hotel className="w-5 h-5" />, 
        desc: "享受最後的海景早餐。",
        // Day 4 第一站：恩納村 (飯店)
        coordinates: { lat: 26.4353, lon: 127.7925 }
      },
      { 
        id: 'd4-2', 
        time: "11:00", 
        title: "港川外人住宅街 / PARCO City", 
        type: "sightseeing", 
        icon: <Coffee className="w-5 h-5" />, 
        desc: "選一個地方逛逛，吃水果塔，買紀念品。",
        travel: { mode: "car", duration: "45 mins" },
        coordinates: { lat: 26.2625, lon: 127.7126 }
      },
      { 
        id: 'd4-3', 
        time: "14:00", 
        title: "前往機場 (OKA)", 
        type: "transport", 
        icon: <Navigation className="w-5 h-5" />, 
        desc: "還車，辦理登機手續。再見沖繩！",
        travel: { mode: "car", duration: "30 mins" },
        coordinates: { lat: 26.2048, lon: 127.6458 }
      },
    ]
  }
];

export default function OkinawaTripApp() {
  const [itinerary, setItinerary] = useState(defaultItinerary);
  const [activeDay, setActiveDay] = useState(1); 
  const [completedItems, setCompletedItems] = useState({});
  const [userNotes, setUserNotes] = useState({});
  const [newNote, setNewNote] = useState("");
  const [viewMode, setViewMode] = useState('itinerary'); 
  const [gpxDataMap, setGpxDataMap] = useState({});
  
  const [weatherData, setWeatherData] = useState({});
  const [loadingWeather, setLoadingWeather] = useState(false);

  // Authentication
  const [user, setUser] = useState(null);
  const [isGpxUploading, setIsGpxUploading] = useState(false);

  // Delete Confirm State
  const [deleteConfirm, setDeleteConfirm] = useState({ isOpen: false, day: null, id: null });

  const [startDate, setStartDate] = useState(() => {
    const d = new Date();
    d.setDate(d.getDate() + 1);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  });

  const [isAddingActivity, setIsAddingActivity] = useState(false);
  const [newActivity, setNewActivity] = useState({
    time: "",
    title: "",
    type: "sightseeing",
    desc: "",
    travelMode: "car",
    travelDuration: "",
    address: "",
    coordinates: null
  });
  const [isCalculating, setIsCalculating] = useState(false);

  const currentDayData = itinerary.find(d => d.day === activeDay);

  // --- Auth & Data Fetching ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Listen to Public GPX Tracks
  useEffect(() => {
    if (!user) return;
    
    // Using a simple query to get all tracks. 
    // In a real app we might filter by trip ID, here we assume one trip for simplicity or map by day ID
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'gpx_tracks');
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const newMap = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.gpxXml && data.day) {
          newMap[data.day] = parseGPX(data.gpxXml);
        }
      });
      setGpxDataMap(newMap);
    }, (error) => {
      console.error("Error fetching GPX tracks:", error);
    });

    return () => unsubscribe();
  }, [user]);


  const getLocalDateFromString = (dateString) => {
    if (!dateString) return new Date();
    const [y, m, d] = dateString.split('-').map(Number);
    return new Date(y, m - 1, d);
  };

  const getDayDate = (dayIndex) => {
    if (!startDate) return { formatted: '--/--', weekDay: '-', full: '--/--', iso: '' };

    const [y, m, d] = startDate.split('-').map(Number);
    const date = new Date(y, m - 1, d); 

    date.setDate(date.getDate() + (dayIndex - 1));
    
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
    const weekDay = weekDays[date.getDay()];
    
    const isoY = date.getFullYear();
    const isoM = String(month).padStart(2, '0');
    const isoD = String(day).padStart(2, '0');
    
    return {
      formatted: `${month}/${day}`,
      weekDay: weekDay,
      full: `${month}/${day} (${weekDay})`,
      iso: `${isoY}-${isoM}-${isoD}`
    };
  };

  const currentDateInfo = getDayDate(activeDay);

  const openGoogleMaps = (query) => {
    const encodedQuery = encodeURIComponent(query);
    const url = `https://www.google.com/maps/search/?api=1&query=${encodedQuery}`;
    window.open(url, '_blank');
  };

  useEffect(() => {
    const fetchWeather = async () => {
        if (!startDate) return;
        setLoadingWeather(true);
        const newData = {};
        
        const promises = itinerary.map(async (dayItem) => {
            const dateStr = getDayDate(dayItem.day).iso;
            const firstActivityCoords = dayItem.activities[0]?.coordinates;
            const { lat, lon } = firstActivityCoords || dayItem.coordinates;
            
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`;
                const res = await fetch(url);
                
                if (!res.ok) throw new Error("Weather fetch failed");
                
                const data = await res.json();
                if (data.daily && data.daily.weather_code) {
                    return {
                        day: dayItem.day,
                        data: {
                            code: data.daily.weather_code[0],
                            max: data.daily.temperature_2m_max[0],
                            min: data.daily.temperature_2m_min[0],
                            valid: true
                        }
                    };
                }
            } catch (err) {
                console.log(`Weather data unavailable for Day ${dayItem.day} (${dateStr})`);
                return {
                    day: dayItem.day,
                    data: { valid: false }
                };
            }
            return { day: dayItem.day, data: { valid: false } };
        });

        const results = await Promise.all(promises);
        results.forEach(item => {
            newData[item.day] = item.data;
        });

        setWeatherData(newData);
        setLoadingWeather(false);
    };

    fetchWeather();
  }, [startDate, itinerary]); 

  const getWeatherIcon = (code) => {
    if (code === 0) return { icon: <Sun className="w-5 h-5 text-orange-500" />, text: "晴朗" };
    if ([1, 2, 3].includes(code)) return { icon: <Cloud className="w-5 h-5 text-slate-500" />, text: "多雲" };
    if ([45, 48].includes(code)) return { icon: <Wind className="w-5 h-5 text-slate-400" />, text: "霧" };
    if (code >= 51 && code <= 67) return { icon: <CloudRain className="w-5 h-5 text-blue-400" />, text: "有雨" };
    if (code >= 80 && code <= 82) return { icon: <CloudRain className="w-5 h-5 text-blue-600" />, text: "陣雨" };
    if (code >= 95) return { icon: <CloudLightning className="w-5 h-5 text-purple-500" />, text: "雷雨" };
    
    return { icon: <Sun className="w-5 h-5 text-orange-400" />, text: "晴時多雲" };
  };

  const currentDayWeather = weatherData[activeDay];

  const toggleComplete = (id) => {
    setCompletedItems(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const addNote = () => {
    if (!newNote.trim()) return;
    const currentNotes = userNotes[activeDay] || [];
    setUserNotes({
      ...userNotes,
      [activeDay]: [...currentNotes, { id: Date.now(), text: newNote }]
    });
    setNewNote("");
  };

  const deleteNote = (noteId) => {
    const currentNotes = userNotes[activeDay] || [];
    setUserNotes({
      ...userNotes,
      [activeDay]: currentNotes.filter(n => n.id !== noteId)
    });
  };

  const confirmDeleteActivity = () => {
    if (!deleteConfirm.day || !deleteConfirm.id) return;
    
    setItinerary(prev => prev.map(day => {
      if (day.day === deleteConfirm.day) {
        return {
          ...day,
          activities: day.activities.filter(act => act.id !== deleteConfirm.id)
        };
      }
      return day;
    }));
    setDeleteConfirm({ isOpen: false, day: null, id: null });
  };

  const handleGpxUpload = async (day, gpxString) => {
    if (!user) {
        alert("請先等待系統連線...");
        return;
    }
    
    setIsGpxUploading(true);
    
    // Parse locally for immediate feedback? 
    // We can rely on listener, but parsing ensures validity first.
    const parsedData = parseGPX(gpxString);
    if (!parsedData) {
        alert("GPX 檔案格式錯誤或無效");
        setIsGpxUploading(false);
        return;
    }

    try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'gpx_tracks', `day_${day}`);
        await setDoc(docRef, {
            day: day,
            gpxXml: gpxString,
            updatedAt: new Date().toISOString(),
            uploaderId: user.uid
        });
        // Success - UI will update via onSnapshot
    } catch (error) {
        console.error("Upload failed", error);
        alert("上傳失敗，請稍後再試");
    } finally {
        setIsGpxUploading(false);
        setViewMode('map');
    }
  };

  const calculateDistance = (lat1, lon1, lat2, lon2) => {
    const R = 6371; // km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  };

  const fetchCoordinates = async (address) => {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
      const data = await response.json();
      if (data && data.length > 0) {
        return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
      }
    } catch (e) {
      console.error("Geocoding failed", e);
    }
    return null;
  };

  const handleCalculateTravel = async () => {
    if (!newActivity.address || !newActivity.time) {
        alert("請先輸入時間與地址");
        return;
    }
    setIsCalculating(true);
    
    const newCoords = await fetchCoordinates(newActivity.address);
    if (!newCoords) {
      alert("找不到該地址的座標，請嘗試更具體的地名");
      setIsCalculating(false);
      return;
    }
    
    let prevCoords = null;
    const sortedActivities = [...currentDayData.activities].sort((a, b) => a.time.localeCompare(b.time));
    
    const prevActivity = sortedActivities.reverse().find(act => act.time < newActivity.time);
    
    if (prevActivity && prevActivity.coordinates) {
        prevCoords = prevActivity.coordinates;
    } else {
        prevCoords = currentDayData.coordinates;
    }

    if (prevCoords) {
      const distanceKm = calculateDistance(prevCoords.lat, prevCoords.lon, newCoords.lat, newCoords.lon);
      
      let speed = 40; 
      if (newActivity.travelMode === 'bike') speed = 15;
      if (newActivity.travelMode === 'walk') speed = 5;
      if (newActivity.travelMode === 'bus') speed = 25;

      const durationHours = (distanceKm * 1.2) / speed; 
      const durationMins = Math.round(durationHours * 60);
      
      setNewActivity(prev => ({
        ...prev,
        coordinates: newCoords,
        travelDuration: Math.max(5, durationMins)
      }));
    } else {
      setNewActivity(prev => ({ ...prev, coordinates: newCoords }));
    }
    
    setIsCalculating(false);
  };

  const handleAddActivity = () => {
    if (!newActivity.title || !newActivity.time) return;

    let IconComponent = Navigation;
    if (newActivity.type === 'food') IconComponent = Utensils;
    if (newActivity.type === 'sightseeing') IconComponent = Sun;
    if (newActivity.type === 'hotel') IconComponent = Hotel;
    if (newActivity.type === 'leisure') IconComponent = Coffee;

    const newItem = {
      id: `new-${Date.now()}`,
      time: newActivity.time,
      title: newActivity.title,
      type: newActivity.type,
      icon: <IconComponent className="w-5 h-5" />,
      desc: newActivity.desc,
      travel: {
        mode: newActivity.travelMode,
        duration: newActivity.travelDuration ? `${newActivity.travelDuration} mins` : "15 mins"
      },
      coordinates: newActivity.coordinates
    };

    setItinerary(prev => prev.map(day => {
      if (day.day === activeDay) {
        const updatedActivities = [...day.activities, newItem].sort((a, b) => 
          a.time.localeCompare(b.time)
        );
        return { ...day, activities: updatedActivities };
      }
      return day;
    }));

    setIsAddingActivity(false);
    setNewActivity({ time: "", title: "", type: "sightseeing", desc: "", travelMode: "car", travelDuration: "", address: "", coordinates: null });
  };

  useEffect(() => {
    if (activeDay === 2 && gpxDataMap[2]) {
      setViewMode('map');
    }
  }, [activeDay, gpxDataMap]);

  const getTransportIcon = (mode) => {
    if (mode === 'car') return <Car size={12} />;
    if (mode === 'bike') return <Bike size={12} />;
    if (mode === 'walk') return <Footprints size={12} />;
    if (mode === 'bus') return <Bus size={12} />;
    return <Navigation size={12} />;
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20 relative">
      
      {deleteConfirm.isOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform scale-100 transition-transform">
            <div className="flex items-center gap-3 text-red-600 mb-4">
              <div className="bg-red-100 p-2 rounded-full">
                <AlertTriangle size={24} />
              </div>
              <h3 className="text-lg font-bold">確認刪除</h3>
            </div>
            <p className="text-slate-600 mb-6">
              您確定要刪除這個行程嗎？此動作無法復原。
            </p>
            <div className="flex gap-3">
              <button 
                onClick={() => setDeleteConfirm({ isOpen: false, day: null, id: null })}
                className="flex-1 py-2.5 px-4 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors"
              >
                取消
              </button>
              <button 
                onClick={confirmDeleteActivity}
                className="flex-1 py-2.5 px-4 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 shadow-md shadow-red-200 transition-colors"
              >
                確認刪除
              </button>
            </div>
          </div>
        </div>
      )}

      <header className="bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-6 sticky top-0 z-40 shadow-lg">
        <div className="flex justify-between items-center max-w-md mx-auto">
          <div>
            <h1 className="text-xl font-bold flex items-center gap-2">
              <Waves className="w-6 h-6" />
              沖繩單車之旅
            </h1>
            <p className="text-cyan-100 text-sm mt-1">4天3夜 • 中北部海岸</p>
          </div>
          <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
            <Bike className="w-6 h-6" />
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4 space-y-6">
        
        <div className="flex justify-between gap-2 overflow-x-auto pb-2 scrollbar-hide">
          {itinerary.map((day) => {
            const dateInfo = getDayDate(day.day);
            return (
              <button
                key={day.day}
                onClick={() => {
                  setActiveDay(day.day);
                  if (day.isCyclingDay && gpxDataMap[day.day]) {
                      setViewMode('map');
                  } else {
                      setViewMode('itinerary');
                  }
                }}
                className={`flex-1 min-w-[80px] py-2 px-2 rounded-xl flex flex-col items-center justify-center transition-all ${
                  activeDay === day.day
                    ? "bg-blue-600 text-white shadow-md transform scale-105"
                    : "bg-white text-slate-500 border border-slate-200"
                }`}
              >
                <span className="text-[10px] font-medium uppercase tracking-wider opacity-80">Day {day.day}</span>
                <span className="text-lg font-bold">{dateInfo.formatted}</span>
                <span className="text-[10px] opacity-80">({dateInfo.weekDay})</span>
              </button>
            );
          })}
        </div>

        <div className="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
          <div className="flex justify-between items-start mb-4">
            <div>
              <div className="flex items-center gap-2 mb-1">
                <span className="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">
                  {currentDateInfo.full}
                </span>
                {currentDayData.isCyclingDay && (
                  <span className="bg-orange-100 text-orange-700 text-xs font-bold px-2 py-0.5 rounded border border-orange-200">
                    騎行日
                  </span>
                )}
              </div>
              <h2 className="text-2xl font-bold text-slate-800">{currentDayData.title}</h2>
              <div className="flex items-center text-slate-500 text-sm mt-1">
                <MapPin className="w-4 h-4 mr-1" />
                {currentDayData.location}
              </div>
            </div>
            
            <div className="bg-slate-50 border border-slate-200 rounded-lg p-2 flex flex-col items-center min-w-[70px] transition-all">
              {loadingWeather ? (
                <Loader2 className="w-5 h-5 text-blue-500 animate-spin" />
              ) : currentDayWeather?.valid ? (
                <>
                  {getWeatherIcon(currentDayWeather.code).icon}
                  <span className="text-sm font-bold text-slate-700 mt-1 leading-none whitespace-nowrap">
                    {Math.round(currentDayWeather.min)}° - {Math.round(currentDayWeather.max)}°
                  </span>
                  <span className="text-[10px] text-slate-500 mt-1">
                    {getWeatherIcon(currentDayWeather.code).text}
                  </span>
                </>
              ) : (
                <>
                  <AlertCircle className="w-5 h-5 text-slate-300" />
                  <span className="text-[10px] text-slate-400 mt-2 text-center leading-tight">
                    無預報
                  </span>
                </>
              )}
            </div>
          </div>

          {activeDay === 1 && (
            <div className="mb-4 bg-blue-50 p-3 rounded-xl flex items-center justify-between border border-blue-100 animate-in fade-in slide-in-from-top-2">
              <div className="flex items-center gap-2 text-blue-800 font-bold text-sm">
                <CalendarDays className="w-4 h-4" />
                <span>旅行開始日期</span>
              </div>
              <input 
                type="date" 
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                onClick={(e) => e.stopPropagation()} 
                className="bg-white border border-blue-200 rounded px-2 py-1 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-400 cursor-pointer"
              />
            </div>
          )}

          <p className="text-slate-600 text-sm leading-relaxed mt-2 border-t border-slate-100 pt-3">
            {currentDayData.summary}
          </p>

          {currentDayData.isCyclingDay && (
            <div className="flex mt-6 bg-slate-100 p-1 rounded-xl">
              <button 
                onClick={() => setViewMode('itinerary')}
                className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${
                  viewMode === 'itinerary' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500'
                }`}
              >
                <Calendar size={16} /> 行程列表
              </button>
              <button 
                onClick={() => setViewMode('map')}
                className={`flex-1 py-2 text-sm font-bold rounded-lg transition-all flex items-center justify-center gap-2 ${
                  viewMode === 'map' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'
                }`}
              >
                <MapIcon size={16} /> 路線地圖
              </button>
            </div>
          )}
        </div>

        {viewMode === 'map' && currentDayData.isCyclingDay ? (
          <div className="space-y-4">
             <RouteVisualizer 
               gpxData={gpxDataMap[activeDay]} 
               onUpload={(data) => handleGpxUpload(activeDay, data)} 
               isUploading={isGpxUploading}
             />
             
             {!gpxDataMap[activeDay] && (
               <div className="bg-white rounded-xl p-4 border border-slate-200 opacity-60">
                 <div className="text-xs font-bold text-slate-400 mb-2 uppercase">預估數據 (上傳 GPX 獲取精確值)</div>
                 <div className="grid grid-cols-3 gap-2 text-center">
                    <div>
                      <div className="text-xs text-slate-400">距離</div>
                      <div className="font-bold">{currentDayData.rideStats.distance}</div>
                    </div>
                    <div>
                      <div className="text-xs text-slate-400">爬升</div>
                      <div className="font-bold">{currentDayData.rideStats.elevation}</div>
                    </div>
                    <div>
                      <div className="text-xs text-slate-400">難度</div>
                      <div className="font-bold">{currentDayData.rideStats.difficulty}</div>
                    </div>
                  </div>
               </div>
             )}
          </div>
        ) : (
          <>
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3 className="text-lg font-bold text-slate-800 flex items-center">
                  <Calendar className="w-5 h-5 mr-2 text-blue-500" />
                  當日行程
                </h3>
                <button 
                  onClick={() => setIsAddingActivity(true)}
                  className="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 flex items-center gap-1"
                >
                  <Plus size={14} /> 新增
                </button>
              </div>
              
              <div className="relative border-l-2 border-slate-200 ml-3 space-y-6 pb-2">
                {currentDayData.activities.map((activity, index) => {
                  const isCompleted = completedItems[activity.id];
                  return (
                    <div key={activity.id} className="relative pl-8 pr-2">
                      {index > 0 && activity.travel && (
                        <div className="absolute -left-[2px] -top-12 h-12 flex flex-col items-center justify-center w-4 z-0">
                           <div className="bg-slate-100 border border-slate-300 rounded px-1.5 py-0.5 text-[10px] text-slate-500 flex items-center gap-1 shadow-sm transform -translate-x-1/2 ml-0.5 whitespace-nowrap">
                             {getTransportIcon(activity.travel.mode)}
                             <span>{activity.travel.duration}</span>
                           </div>
                        </div>
                      )}

                      <div 
                        onClick={() => toggleComplete(activity.id)}
                        className={`absolute -left-[9px] top-1 w-5 h-5 rounded-full border-2 flex items-center justify-center cursor-pointer bg-white transition-colors z-10 ${
                          isCompleted ? "border-green-500 text-green-500" : "border-slate-300 text-transparent"
                        }`}
                      >
                        <div className={`w-2.5 h-2.5 rounded-full ${isCompleted ? "bg-green-500" : ""}`} />
                      </div>

                      <div 
                        className={`relative rounded-xl p-4 transition-all duration-300 group ${
                          isCompleted 
                            ? "bg-slate-50 border border-slate-100 opacity-60" 
                            : "bg-white border border-slate-200 shadow-sm hover:shadow-md"
                        }`}
                      >
                        <button 
                          onClick={(e) => {
                            e.stopPropagation();
                            setDeleteConfirm({ isOpen: true, day: currentDayData.day, id: activity.id });
                          }}
                          className="absolute top-2 right-2 text-slate-300 hover:text-red-500 p-1 rounded-full hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-all"
                        >
                          <Trash2 size={16} />
                        </button>

                        <div className="flex justify-between items-start mb-1 pr-6">
                          <div className="flex items-center gap-2">
                            <span className={`text-sm font-mono font-semibold ${isCompleted ? "text-slate-400" : "text-blue-600"}`}>
                              {activity.time}
                            </span>
                            
                            <h4 
                              onClick={(e) => {
                                e.stopPropagation();
                                openGoogleMaps(activity.title);
                              }}
                              className={`font-bold hover:text-blue-600 hover:underline cursor-pointer flex items-center gap-1 transition-colors ${isCompleted ? "text-slate-500 line-through" : "text-slate-800"}`}
                            >
                              {activity.title}
                              <ExternalLink size={12} className="opacity-40" />
                            </h4>
                          </div>
                          <div className={`p-1.5 rounded-full ${isCompleted ? "bg-slate-100 text-slate-400" : "bg-blue-50 text-blue-500"}`}>
                            {activity.icon}
                          </div>
                        </div>
                        <p className="text-sm text-slate-500 leading-snug">
                          {activity.desc}
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>

              {isAddingActivity && (
                <div className="bg-white rounded-xl p-4 border-2 border-blue-100 shadow-lg animate-in fade-in slide-in-from-bottom-4">
                  <div className="flex justify-between items-center mb-3">
                    <h4 className="font-bold text-slate-700">新增行程</h4>
                    <button onClick={() => setIsAddingActivity(false)}><X size={18} className="text-slate-400" /></button>
                  </div>
                  
                  <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="text-xs text-slate-500 font-bold block mb-1">時間</label>
                        <input 
                          type="time" 
                          value={newActivity.time}
                          onChange={e => setNewActivity({...newActivity, time: e.target.value})}
                          className="w-full text-sm p-2 border rounded bg-slate-50" 
                        />
                      </div>
                      <div>
                        <label className="text-xs text-slate-500 font-bold block mb-1">類型</label>
                        <select 
                          value={newActivity.type}
                          onChange={e => setNewActivity({...newActivity, type: e.target.value})}
                          className="w-full text-sm p-2 border rounded bg-slate-50"
                        >
                          <option value="sightseeing">景點</option>
                          <option value="food">餐廳</option>
                          <option value="leisure">休閒</option>
                          <option value="transport">交通/移動</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <label className="text-xs text-slate-500 font-bold block mb-1">地點/地址 (用於計算交通)</label>
                      <div className="flex gap-2">
                        <input 
                          type="text" 
                          placeholder="例如: 萬座毛"
                          value={newActivity.address}
                          onChange={e => setNewActivity({...newActivity, address: e.target.value, title: e.target.value})} 
                          className="flex-1 text-sm p-2 border rounded bg-slate-50"
                        />
                        <button 
                          onClick={handleCalculateTravel}
                          disabled={!newActivity.address || !newActivity.time || isCalculating}
                          className="bg-blue-100 text-blue-700 px-3 rounded hover:bg-blue-200 disabled:opacity-50 flex items-center gap-1 text-xs font-bold whitespace-nowrap"
                          title="搜尋地址並計算與上一站的交通時間"
                        >
                          {isCalculating ? <Loader2 size={14} className="animate-spin" /> : <Search size={14} />}
                          <span>計算交通</span>
                        </button>
                      </div>
                      {newActivity.coordinates && <span className="text-[10px] text-green-600 flex items-center gap-1 mt-1"><CheckCircle2 size={10} /> 已定位並計算</span>}
                    </div>

                    <div>
                      <label className="text-xs text-slate-500 font-bold block mb-1">標題</label>
                      <input 
                        type="text" 
                        placeholder="行程名稱"
                        value={newActivity.title}
                        onChange={e => setNewActivity({...newActivity, title: e.target.value})}
                        className="w-full text-sm p-2 border rounded bg-slate-50"
                      />
                    </div>

                    <div>
                      <label className="text-xs text-slate-500 font-bold block mb-1">備註/描述</label>
                      <textarea 
                        rows="2"
                        placeholder="細節..."
                        value={newActivity.desc}
                        onChange={e => setNewActivity({...newActivity, desc: e.target.value})}
                        className="w-full text-sm p-2 border rounded bg-slate-50"
                      />
                    </div>

                    <div className="bg-blue-50 p-3 rounded-lg">
                      <label className="text-xs text-blue-600 font-bold block mb-2 flex items-center gap-1">
                        <Navigation size={12} /> 與上一行程的交通
                      </label>
                      <div className="grid grid-cols-2 gap-2">
                        <select 
                          value={newActivity.travelMode}
                          onChange={e => setNewActivity({...newActivity, travelMode: e.target.value})}
                          className="text-sm p-1.5 border border-blue-200 rounded"
                        >
                          <option value="car">開車</option>
                          <option value="bike">騎車</option>
                          <option value="walk">步行</option>
                          <option value="bus">公車</option>
                        </select>
                        <div className="flex items-center">
                          <input 
                            type="number" 
                            placeholder="分鐘"
                            value={newActivity.travelDuration}
                            onChange={e => setNewActivity({...newActivity, travelDuration: e.target.value})}
                            className="w-full text-sm p-1.5 border border-blue-200 rounded-l"
                          />
                          <span className="text-xs bg-blue-200 text-blue-800 px-2 py-2 rounded-r">min</span>
                        </div>
                      </div>
                    </div>

                    <button 
                      onClick={handleAddActivity}
                      className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2"
                    >
                      <Save size={16} /> 儲存行程
                    </button>
                  </div>
                </div>
              )}
            </div>

            <div className="bg-yellow-50 rounded-2xl p-5 border border-yellow-100">
              <h3 className="text-md font-bold text-yellow-800 mb-3 flex items-center">
                📝 我的筆記
              </h3>
              {userNotes[activeDay] && userNotes[activeDay].length > 0 ? (
                <ul className="space-y-2 mb-4">
                  {userNotes[activeDay].map(note => (
                    <li key={note.id} className="flex justify-between items-start bg-white p-3 rounded-lg border border-yellow-100 text-sm text-slate-700 shadow-sm">
                      <span>{note.text}</span>
                      <button onClick={() => deleteNote(note.id)} className="text-slate-300 hover:text-red-400 ml-2">×</button>
                    </li>
                  ))}
                </ul>
              ) : (
                <div className="text-center text-yellow-600/50 text-sm mb-4 py-2 italic">
                  還沒有筆記，點擊下方新增。
                </div>
              )}
              <div className="flex gap-2">
                <input
                  type="text"
                  value={newNote}
                  onChange={(e) => setNewNote(e.target.value)}
                  placeholder="新增備忘錄"
                  className="flex-1 px-4 py-2 rounded-lg border border-yellow-200 focus:outline-none focus:ring-2 focus:ring-yellow-400 text-sm"
                  onKeyPress={(e) => e.key === 'Enter' && addNote()}
                />
                <button 
                  onClick={addNote}
                  className="bg-yellow-400 text-yellow-900 p-2 rounded-lg hover:bg-yellow-500 transition-colors"
                >
                  <Plus className="w-5 h-5" />
                </button>
              </div>
            </div>
          </>
        )}

      </main>
    </div>
  );
}
